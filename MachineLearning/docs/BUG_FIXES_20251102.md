# üîß Bug Fixes: Repository Processing Issues (Nov 2, 2025)

## üêõ Problemi Risolti

### 1. KeyError: 'name' durante l'estrazione funzioni
### 2. PermissionError su Windows durante cleanup
### 3. Gestione repository non trovati

---

## 1Ô∏è‚É£ Fix: KeyError 'name'

### **Problema**
```python
ERROR - Error processing https://github.com/pytorch/fairseq: 'name'
ERROR - Error processing https://github.com/microsoft/nni: 'name'
```

Il parser a volte non riesce ad estrarre il campo 'name' dalle funzioni, causando un KeyError.

### **Soluzione**
Aggiunto controllo preventivo prima di accedere ai campi:

```python
# Prima
for func in functions:
    if not self.duplicate_manager.is_duplicate(func['hash'], {'function': func['name']}):
        # ... KeyError se 'name' manca!

# Dopo  
for func in functions:
    # Skip if no name or body
    if not func.get('name') or not func.get('body'):
        continue
    
    if not self.duplicate_manager.is_duplicate(func['hash'], {'function': func['name']}):
        # ... ora sicuro!
```

---

## 2Ô∏è‚É£ Fix: PermissionError Windows Cleanup

### **Problema**
```python
ERROR - Failed to cleanup C:\...\pytorch_fairseq: [WinError 5] Accesso negato
ERROR - Failed to cleanup C:\...\microsoft_nni: [WinError 5] Accesso negato
```

Su Windows, Git blocca i file `.git/objects/pack/*.idx` impedendo la cancellazione.

### **Soluzione**
Implementato retry logic con cambio permessi:

```python
# Retry fino a 3 volte
max_retries = 3
for attempt in range(max_retries):
    try:
        shutil.rmtree(local_path)
        break
    except PermissionError:
        if attempt < max_retries - 1:
            time.sleep(0.5)
            # Cambia permessi
            for root, dirs, files in os.walk(local_path):
                for dir in dirs:
                    os.chmod(os.path.join(root, dir), stat.S_IRWXU)
                for file in files:
                    os.chmod(os.path.join(root, file), stat.S_IRWXU)
        else:
            logger.warning(f"Could not cleanup after {max_retries} attempts")
```

---

## 3Ô∏è‚É£ Fix: Repository Not Found

### **Problema**
```python
ERROR - Failed to clone: Repository not found
```

Alcuni repository potrebbero essere stati rimossi o resi privati.

### **Soluzione**
Distinguere tra repository non trovati (warning) e altri errori:

```python
if result.returncode != 0:
    error_msg = result.stderr.lower()
    if 'repository not found' in error_msg:
        logger.warning(f"Repository not found or private: {repo_url}")
    else:
        logger.error(f"Failed to clone {repo_url}: {result.stderr}")
```

---

## ‚úÖ Risultati

**Prima:**
- ‚ùå Crash su funzioni senza 'name'
- ‚ùå Errori di cleanup bloccano il processing
- ‚ùå Log confusi per repo non trovati

**Dopo:**
- ‚úÖ Skip automatico funzioni incomplete
- ‚úÖ Cleanup con retry e fallback graceful
- ‚úÖ Log chiari e informativi
- ‚úÖ Processing continua senza interruzioni

---

## üß™ Test

Esegui il test:
```bash
.\.venv\Scripts\activate
python test_repo_processor.py
```

Verifica:
- ‚úÖ Nessun KeyError
- ‚úÖ Cleanup funziona (o warning chiaro)
- ‚úÖ Gestione corretta errori clone
