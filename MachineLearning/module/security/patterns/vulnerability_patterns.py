"""
Vulnerability Patterns Library

Common vulnerability patterns for detection across multiple languages.
Based on OWASP Top 10 and CWE classifications.

Usage:
    from module.security.patterns.vulnerability_patterns import VULNERABILITY_PATTERNS
    patterns = VULNERABILITY_PATTERNS['sql_injection']
"""

# OWASP Top 10 and Common Vulnerability Patterns
VULNERABILITY_PATTERNS = {
    # ==========================================
    # A03: Injection Vulnerabilities
    # ==========================================

    'sql_injection': {
        'cwe': 'CWE-89',
        'owasp': 'A03:2021 - Injection',
        'severity': 'HIGH',
        'description': 'SQL injection vulnerability via string concatenation or formatting',
        'languages': ['python', 'java', 'php', 'javascript', 'ruby', 'go'],
        'patterns': {
            'python': [
                r'\.execute\s*\([^)]*\+[^)]*\)',          # cursor.execute("..." + var + "...")
                r'\.execute\s*\([^)]*%[^)]*\)',           # cursor.execute("..." % var)
                r'\.execute\s*\(f["\']',                  # cursor.execute(f"...")
                r'\.execute\s*\([^)]*\.format\(',         # cursor.execute("...".format(...))
                r'\.raw\s*\([^)]*\+',                     # Django .raw() with concatenation
                r'connection\.execute\s*\([^)]*\+',       # SQLAlchemy execute with concat
            ],
            'java': [
                r'Statement\s*\.\s*execute\w*\s*\([^)]*\+',  # statement.execute("..." + var)
                r'createStatement\s*\(\s*\)\s*\.\s*execute',  # No PreparedStatement
            ],
            'php': [
                r'mysql_query\s*\([^)]*\$',                # mysql_query with variable
                r'mysqli_query\s*\([^)]*\$',               # mysqli_query with variable
                r'\$wpdb->query\s*\([^)]*\$',              # WordPress DB query
            ],
            'javascript': [
                r'query\s*\([^)]*\+[^)]*\)',               # db.query("..." + var)
                r'\.execute\s*\(`[^`]*\$\{',               # execute(`...${var}`)
            ],
        },
        'safe_patterns': [
            r'\.execute\s*\([^,)]+,\s*\(',                # Parameterized: execute(query, (params,))
            r'PreparedStatement',                          # Java PreparedStatement
            r'prepare\s*\(',                               # prepare() statement
        ],
        'fix': 'Use parameterized queries:\n  cursor.execute("SELECT * FROM users WHERE id=?", (user_id,))',
        'references': [
            'https://owasp.org/www-community/attacks/SQL_Injection',
            'https://cwe.mitre.org/data/definitions/89.html',
        ],
        'examples': {
            'vulnerable': 'cursor.execute(f"SELECT * FROM users WHERE id={user_id}")',
            'safe': 'cursor.execute("SELECT * FROM users WHERE id=?", (user_id,))',
        },
    },

    'command_injection': {
        'cwe': 'CWE-78',
        'owasp': 'A03:2021 - Injection',
        'severity': 'CRITICAL',
        'description': 'OS command injection via unsanitized user input',
        'languages': ['python', 'java', 'php', 'javascript', 'ruby', 'go'],
        'patterns': {
            'python': [
                r'os\.system\s*\(',                        # os.system()
                r'os\.popen\s*\(',                         # os.popen()
                r'subprocess\.\w+\s*\([^)]*shell\s*=\s*True',  # subprocess with shell=True
                r'eval\s*\(',                              # eval()
                r'exec\s*\(',                              # exec()
                r'__import__\s*\(',                        # __import__()
                r'compile\s*\(',                           # compile()
            ],
            'java': [
                r'Runtime\.getRuntime\(\)\.exec',          # Runtime.exec()
                r'ProcessBuilder\s*\(\s*".*\s.*"',         # ProcessBuilder with space (shell)
            ],
            'php': [
                r'exec\s*\(',                              # exec()
                r'shell_exec\s*\(',                        # shell_exec()
                r'system\s*\(',                            # system()
                r'passthru\s*\(',                          # passthru()
                r'`[^`]*\$',                               # Backticks with variable
            ],
            'javascript': [
                r'child_process\.exec\s*\(',               # child_process.exec()
                r'eval\s*\(',                              # eval()
            ],
        },
        'safe_patterns': [
            r'subprocess\.\w+\s*\(\[',                     # subprocess with list (no shell)
            r'shlex\.quote\s*\(',                          # Input sanitization
        ],
        'fix': 'Use subprocess with list arguments (no shell=True):\n  subprocess.run(["ls", "-l", directory])',
        'references': [
            'https://owasp.org/www-community/attacks/Command_Injection',
            'https://cwe.mitre.org/data/definitions/78.html',
        ],
        'examples': {
            'vulnerable': 'os.system(f"cat {filename}")',
            'safe': 'subprocess.run(["cat", filename], check=True)',
        },
    },

    'xss': {
        'cwe': 'CWE-79',
        'owasp': 'A03:2021 - Injection',
        'severity': 'HIGH',
        'description': 'Cross-Site Scripting (XSS) vulnerability',
        'languages': ['javascript', 'python', 'java', 'php'],
        'patterns': {
            'javascript': [
                r'\.innerHTML\s*=\s*(?!["\'])',            # innerHTML = variable
                r'document\.write\s*\([^)]*\+',            # document.write with concat
                r'\.html\s*\([^)]*\+',                     # jQuery .html() with concat
                r'dangerouslySetInnerHTML',                # React dangerous prop
            ],
            'python': [
                r'render_template_string\s*\([^)]*\+',     # Flask template string with concat
                r'mark_safe\s*\(',                         # Django mark_safe
            ],
            'php': [
                r'echo\s+\$_(?:GET|POST|REQUEST)',         # Direct echo of user input
                r'print\s+\$_(?:GET|POST|REQUEST)',        # Direct print
            ],
        },
        'safe_patterns': [
            r'escape\s*\(',                                # Escaping function
            r'sanitize\s*\(',                              # Sanitization
            r'textContent\s*=',                            # textContent (safe)
        ],
        'fix': 'Escape output or use safe methods:\n  element.textContent = userInput  // or use html.escape()',
        'references': [
            'https://owasp.org/www-community/attacks/xss/',
            'https://cwe.mitre.org/data/definitions/79.html',
        ],
        'examples': {
            'vulnerable': 'element.innerHTML = userInput',
            'safe': 'element.textContent = userInput',
        },
    },

    # ==========================================
    # A02: Cryptographic Failures
    # ==========================================

    'weak_crypto': {
        'cwe': 'CWE-327',
        'owasp': 'A02:2021 - Cryptographic Failures',
        'severity': 'MEDIUM',
        'description': 'Use of weak or broken cryptographic algorithms',
        'languages': ['python', 'java', 'javascript', 'php'],
        'patterns': {
            'python': [
                r'hashlib\.md5\s*\(',                      # MD5
                r'hashlib\.sha1\s*\(',                     # SHA1
                r'Crypto\.Cipher\.DES',                    # DES cipher
                r'Crypto\.Cipher\.ARC4',                   # RC4 cipher
                r'MODE_ECB',                               # ECB mode (insecure)
            ],
            'java': [
                r'MessageDigest\.getInstance\s*\(\s*"MD5"', # MD5
                r'MessageDigest\.getInstance\s*\(\s*"SHA1"', # SHA1
                r'Cipher\.getInstance\s*\(\s*"DES',        # DES
                r'Cipher\.getInstance\s*\(\s*"[^"]*ECB',   # ECB mode
            ],
            'javascript': [
                r'createHash\s*\(\s*["\']md5["\']',        # MD5
                r'createHash\s*\(\s*["\']sha1["\']',       # SHA1
            ],
        },
        'safe_patterns': [
            r'hashlib\.sha256',                            # SHA256
            r'hashlib\.sha512',                            # SHA512
            r'bcrypt',                                     # bcrypt
            r'scrypt',                                     # scrypt
            r'Argon2',                                     # Argon2
        ],
        'fix': 'Use strong algorithms:\n  hashlib.sha256() for hashing\n  bcrypt for passwords',
        'references': [
            'https://owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure',
            'https://cwe.mitre.org/data/definitions/327.html',
        ],
        'examples': {
            'vulnerable': 'hashlib.md5(password)',
            'safe': 'bcrypt.hashpw(password, bcrypt.gensalt())',
        },
    },

    'hardcoded_secrets': {
        'cwe': 'CWE-798',
        'owasp': 'A02:2021 - Cryptographic Failures',
        'severity': 'HIGH',
        'description': 'Hardcoded passwords, API keys, or secrets in source code',
        'languages': ['python', 'java', 'javascript', 'php', 'ruby', 'go'],
        'patterns': {
            'all': [
                r'(?:password|passwd|pwd)\s*=\s*["\'][^"\']{4,}["\']',  # password = "..."
                r'(?:api_key|apikey|api-key)\s*=\s*["\'][^"\']{10,}["\']',  # api_key = "..."
                r'(?:secret|secret_key)\s*=\s*["\'][^"\']{10,}["\']',  # secret = "..."
                r'(?:token|access_token)\s*=\s*["\'][^"\']{10,}["\']',  # token = "..."
                r'(?:private_key|private-key)\s*=\s*["\']-----BEGIN',  # private_key = "-----BEGIN..."
                r'aws_access_key_id\s*=\s*["\']A[A-Z0-9]{19}["\']',  # AWS key
                r'(?:ghp|gho|ghu|ghs|ghr)_[A-Za-z0-9]{36}',  # GitHub token
            ],
        },
        'safe_patterns': [
            r'os\.getenv\s*\(',                            # Environment variable
            r'os\.environ\[',                              # Environment variable
            r'process\.env\.',                             # Node.js env
            r'\$_ENV\[',                                   # PHP environment
        ],
        'fix': 'Use environment variables:\n  password = os.getenv("DB_PASSWORD")',
        'references': [
            'https://cwe.mitre.org/data/definitions/798.html',
        ],
        'examples': {
            'vulnerable': 'API_KEY = "sk-1234567890abcdef"',
            'safe': 'API_KEY = os.getenv("API_KEY")',
        },
    },

    # ==========================================
    # A01: Broken Access Control
    # ==========================================

    'path_traversal': {
        'cwe': 'CWE-22',
        'owasp': 'A01:2021 - Broken Access Control',
        'severity': 'HIGH',
        'description': 'Path traversal allowing access to files outside intended directory',
        'languages': ['python', 'java', 'php', 'javascript'],
        'patterns': {
            'python': [
                r'open\s*\([^)]*\+',                       # open() with concatenation
                r'file\s*\([^)]*\+',                       # file() with concat
                r'Path\s*\([^)]*\+',                       # Path() with concat
            ],
            'javascript': [
                r'fs\.readFile\s*\([^)]*\+',               # fs.readFile with concat
                r'fs\.readFileSync\s*\([^)]*\+',           # fs.readFileSync
            ],
            'php': [
                r'file_get_contents\s*\([^)]*\$',          # file_get_contents with var
                r'include\s*\([^)]*\$',                    # include with var
                r'require\s*\([^)]*\$',                    # require with var
            ],
        },
        'safe_patterns': [
            r'os\.path\.abspath',                          # Absolute path
            r'os\.path\.realpath',                         # Real path
            r'Path\([^)]*\)\.resolve',                     # Resolve path
        ],
        'fix': 'Validate and sanitize file paths:\n  safe_path = os.path.abspath(os.path.join(base_dir, filename))',
        'references': [
            'https://owasp.org/www-community/attacks/Path_Traversal',
            'https://cwe.mitre.org/data/definitions/22.html',
        ],
        'examples': {
            'vulnerable': 'open(user_input)',
            'safe': 'open(os.path.join(SAFE_DIR, os.path.basename(user_input)))',
        },
    },

    # ==========================================
    # A08: Data Integrity Failures
    # ==========================================

    'insecure_deserialization': {
        'cwe': 'CWE-502',
        'owasp': 'A08:2021 - Software and Data Integrity Failures',
        'severity': 'CRITICAL',
        'description': 'Insecure deserialization can lead to remote code execution',
        'languages': ['python', 'java', 'php', 'javascript'],
        'patterns': {
            'python': [
                r'pickle\.loads?\s*\(',                    # pickle.load/loads
                r'jsonpickle\.decode',                     # jsonpickle
                r'yaml\.load\s*\([^)]*(?!Loader)',         # yaml.load without safe_load
                r'marshal\.loads?\s*\(',                   # marshal
            ],
            'java': [
                r'ObjectInputStream\s*\(\s*new',           # ObjectInputStream
                r'readObject\s*\(\s*\)',                   # readObject()
                r'XMLDecoder',                             # XMLDecoder
            ],
            'php': [
                r'unserialize\s*\(',                       # unserialize()
            ],
            'javascript': [
                r'JSON\.parse\s*\([^)]*req\.',             # JSON.parse on request
            ],
        },
        'safe_patterns': [
            r'yaml\.safe_load',                            # Safe YAML loading
            r'json\.loads?',                               # JSON is safer
        ],
        'fix': 'Avoid deserializing untrusted data. Use safe alternatives:\n  yaml.safe_load(data)',
        'references': [
            'https://owasp.org/www-community/vulnerabilities/Deserialization_of_untrusted_data',
            'https://cwe.mitre.org/data/definitions/502.html',
        ],
        'examples': {
            'vulnerable': 'pickle.loads(user_data)',
            'safe': 'json.loads(user_data)  # Use JSON instead',
        },
    },

    # ==========================================
    # A10: Server-Side Request Forgery (SSRF)
    # ==========================================

    'ssrf': {
        'cwe': 'CWE-918',
        'owasp': 'A10:2021 - Server-Side Request Forgery',
        'severity': 'HIGH',
        'description': 'SSRF allows attacker to make server perform requests to arbitrary URLs',
        'languages': ['python', 'java', 'php', 'javascript'],
        'patterns': {
            'python': [
                r'requests\.(?:get|post)\s*\([^)]*\+',     # requests with concat
                r'urllib\.request\.urlopen\s*\([^)]*\+',   # urlopen with concat
                r'httpx\.(?:get|post)\s*\(f["\']',         # httpx with f-string
            ],
            'javascript': [
                r'fetch\s*\([^)]*\+',                      # fetch with concat
                r'axios\.(?:get|post)\s*\([^)]*\+',        # axios with concat
            ],
            'php': [
                r'file_get_contents\s*\([^)]*\$_',         # file_get_contents with user input
                r'curl_setopt\s*\([^)]*CURLOPT_URL[^)]*\$', # curl with user URL
            ],
        },
        'safe_patterns': [
            r'urlparse\s*\(',                              # URL parsing
            r'validate_url',                               # URL validation
            r'whitelist',                                  # Whitelist check
        ],
        'fix': 'Validate URLs against whitelist:\n  if parsed_url.netloc in ALLOWED_HOSTS: ...',
        'references': [
            'https://owasp.org/www-community/attacks/Server_Side_Request_Forgery',
            'https://cwe.mitre.org/data/definitions/918.html',
        ],
        'examples': {
            'vulnerable': 'requests.get(user_url)',
            'safe': 'if urlparse(user_url).netloc in WHITELIST: requests.get(user_url)',
        },
    },

    # ==========================================
    # XXE (XML External Entity)
    # ==========================================

    'xxe': {
        'cwe': 'CWE-611',
        'owasp': 'A05:2021 - Security Misconfiguration',
        'severity': 'HIGH',
        'description': 'XML External Entity (XXE) injection',
        'languages': ['python', 'java', 'php'],
        'patterns': {
            'python': [
                r'etree\.parse\s*\(',                      # lxml parse without safe settings
                r'etree\.fromstring\s*\(',                 # fromstring
                r'xml\.etree\.ElementTree\.parse',         # ElementTree parse
            ],
            'java': [
                r'DocumentBuilderFactory\.newInstance\(\)(?!.*setFeature)', # No setFeature
                r'SAXParserFactory\.newInstance\(\)(?!.*setFeature)',
            ],
            'php': [
                r'simplexml_load_string\s*\(',             # simplexml without LIBXML_NOENT
                r'DOMDocument',                            # DOMDocument
            ],
        },
        'safe_patterns': [
            r'resolve_entities\s*=\s*False',               # Disabled entity resolution
            r'setFeature.*external-general-entities.*false', # Java safe config
        ],
        'fix': 'Disable external entity resolution:\n  parser.set("resolve_entities", False)',
        'references': [
            'https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing',
            'https://cwe.mitre.org/data/definitions/611.html',
        ],
        'examples': {
            'vulnerable': 'tree = etree.parse(user_xml)',
            'safe': 'parser = etree.XMLParser(resolve_entities=False); tree = etree.parse(user_xml, parser)',
        },
    },
}

# Severity levels mapping
SEVERITY_LEVELS = {
    'CRITICAL': 4,
    'HIGH': 3,
    'MEDIUM': 2,
    'LOW': 1,
    'INFO': 0,
}

# OWASP Top 10 2021 mapping
OWASP_TOP_10 = {
    'A01': 'Broken Access Control',
    'A02': 'Cryptographic Failures',
    'A03': 'Injection',
    'A04': 'Insecure Design',
    'A05': 'Security Misconfiguration',
    'A06': 'Vulnerable and Outdated Components',
    'A07': 'Identification and Authentication Failures',
    'A08': 'Software and Data Integrity Failures',
    'A09': 'Security Logging and Monitoring Failures',
    'A10': 'Server-Side Request Forgery',
}


def get_patterns_for_language(language: str):
    """
    Get all patterns applicable to a specific language

    Args:
        language: Programming language (e.g., 'python', 'java')

    Returns:
        Dictionary of vulnerability types and their patterns
    """
    language_patterns = {}

    for vuln_type, vuln_info in VULNERABILITY_PATTERNS.items():
        if language in vuln_info.get('languages', []) or 'all' in vuln_info.get('languages', []):
            patterns = vuln_info.get('patterns', {})
            lang_specific = patterns.get(language, patterns.get('all', []))
            if lang_specific:
                language_patterns[vuln_type] = {
                    'patterns': lang_specific,
                    'info': vuln_info
                }

    return language_patterns


def get_vulnerability_info(vuln_type: str):
    """Get detailed information about a vulnerability type"""
    return VULNERABILITY_PATTERNS.get(vuln_type, {})
